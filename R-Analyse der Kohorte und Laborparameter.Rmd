---
title: "R-Analyse der Kohorte und Laborparameter"
author: "Nina Haffer"
date: "8 2 2022"
output:
  html_document:
    code_folding: hide
---
Für die Beschreibung der Kohorte ist folgender R-Code geschrieben worden, Um diesen auszuführen, ist es nötig den Arbeitsbereich mit der Funktion setwd() vorher zu definieren, in dem die Exceldateien liegen, die zur Analyse benötigt werden.

# Beschreibung der Kohorte
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")

#Anzahl männlich und weiblich
anzahl_geschlecht <- table(Geschlecht_und_Alter$Geschlecht)

#Altersverteilung
shapiro.test(Geschlecht_und_Alter$Alter) # keine Normalverteilung, da p < 0.05
summary(Geschlecht_und_Alter)


Weiblich_und_Alter  <- Geschlecht_und_Alter %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(Geschlecht %in%  c("Weiblich"), )

Männlich_und_Alter <- Geschlecht_und_Alter %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(Geschlecht %in%  c("Männlich"), )

shapiro.test(Weiblich_und_Alter$Alter) 
shapiro.test(Männlich_und_Alter$Alter) 

kl5 <- Geschlecht_und_Alter[Geschlecht_und_Alter$Alter < 5, ]
kl10 <- Geschlecht_und_Alter[Geschlecht_und_Alter$Alter < 10, ]
kl20 <- Geschlecht_und_Alter[Geschlecht_und_Alter$Alter < 20, ]
kl30 <- Geschlecht_und_Alter[Geschlecht_und_Alter$Alter < 30, ]
kl40 <- Geschlecht_und_Alter[Geschlecht_und_Alter$Alter < 40, ]
kl50 <- Geschlecht_und_Alter[Geschlecht_und_Alter$Alter < 50, ]
gr50 <- Geschlecht_und_Alter[Geschlecht_und_Alter$Alter > 50, ]
gr60 <- Geschlecht_und_Alter[Geschlecht_und_Alter$Alter > 60, ]
gr70 <- Geschlecht_und_Alter[Geschlecht_und_Alter$Alter > 70, ]
gr80 <- Geschlecht_und_Alter[Geschlecht_und_Alter$Alter > 80, ]
gr90 <- Geschlecht_und_Alter[Geschlecht_und_Alter$Alter > 90, ]
gr95 <- Geschlecht_und_Alter[Geschlecht_und_Alter$Alter > 95, ]


Männlich_kl5 <- Männlich_und_Alter[Männlich_und_Alter$Alter < 5, ]
Männlich_kl10 <- Männlich_und_Alter[Männlich_und_Alter$Alter < 10, ]
Männlich_kl20 <- Männlich_und_Alter[Männlich_und_Alter$Alter < 20, ]
Männlich_kl30 <- Männlich_und_Alter[Männlich_und_Alter$Alter < 30, ]
Männlich_kl40 <- Männlich_und_Alter[Männlich_und_Alter$Alter < 40, ]
Männlich_kl50 <- Männlich_und_Alter[Männlich_und_Alter$Alter < 50, ]
Männlich_kl50 <- Männlich_und_Alter[Männlich_und_Alter$Alter < 50, ]
Männlich_gr50 <- Männlich_und_Alter[Männlich_und_Alter$Alter > 50, ]
Männlich_gr60 <- Männlich_und_Alter[Männlich_und_Alter$Alter > 60, ]
Männlich_gr70 <- Männlich_und_Alter[Männlich_und_Alter$Alter > 70, ]
Männlich_gr80 <- Männlich_und_Alter[Männlich_und_Alter$Alter > 80, ]
Männlich_gr90 <- Männlich_und_Alter[Männlich_und_Alter$Alter > 90, ]
Männlich_gr95 <- Männlich_und_Alter[Männlich_und_Alter$Alter > 95, ]

Weiblich_kl5 <- Weiblich_und_Alter[Weiblich_und_Alter$Alter < 5, ]
Weiblich_kl10 <- Weiblich_und_Alter[Weiblich_und_Alter$Alter < 10, ]
Weiblich_kl20 <- Weiblich_und_Alter[Weiblich_und_Alter$Alter < 20, ]
Weiblich_kl30 <- Weiblich_und_Alter[Weiblich_und_Alter$Alter < 30, ]
Weiblich_kl40 <- Weiblich_und_Alter[Weiblich_und_Alter$Alter < 40, ]
Weiblich_kl50 <- Weiblich_und_Alter[Weiblich_und_Alter$Alter < 50, ]
Weiblich_gr50 <- Weiblich_und_Alter[Weiblich_und_Alter$Alter > 50, ]
Weiblich_gr60 <- Weiblich_und_Alter[Weiblich_und_Alter$Alter > 60, ]
Weiblich_gr70 <- Weiblich_und_Alter[Weiblich_und_Alter$Alter > 70, ]
Weiblich_gr80 <- Weiblich_und_Alter[Weiblich_und_Alter$Alter > 80, ]
Weiblich_gr90 <- Weiblich_und_Alter[Weiblich_und_Alter$Alter > 90, ]
Weiblich_gr95 <- Weiblich_und_Alter[Weiblich_und_Alter$Alter > 95, ]

data  <- Geschlecht_und_Alter %>% 
  drop_na(Alter,Geschlecht)
data_w <- data %>%
  filter(Geschlecht=="Weiblich")
data_m <- data %>%
  filter(Geschlecht=="Männlich")

hist(data$Alter, main="Altersverteilung der Pa-COVID-Studienteilnehmer", xlab="Alter [J]", ylab="Anzahl", breaks = 10)

# übereinandergelegte histogramme zum Alter
h1w <- hist(data_m$Alter, main="Alter", xlab="Alter", ylab="Anzahl", breaks = 100)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(data_w$Alter, main="Alter", xlab="Alter", ylab="Anzahl", breaks = 100)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung der gesamten Kohorte", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,7),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), main="Altersverteilung der gesamten Kohorte", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100),  add=T, freq=FALSE)  # second

#Altersverteilung männl. weibl.
shapiro.test(data_w$Alter) # Normalverteilung
shapiro.test(data_m$Alter) # keine Normalverteilung, da p < 0.05

summary(Geschlecht_und_Alter)
summary(data)
summary(data_m)
summary(data_w)

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(data)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(data)

wilcox.test(data_w$Alter,data_m$Alter, paired=FALSE)
```




Im Folgenden werden die R-Skripte, die für die Analyse der Laborparameter geschrieben wurden, aufgelistet. Um diese auszuführen, ist es nötig den Arbeitsbereich mit der Funktion setwd() vorher zu definieren, in dem die Exceldateien liegen, die zur Analyse benötigt werden.




#C-reaktives Protein
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaCrp2108.xlsx")
names(data)

erg  <- data %>% 
  #.	Filtern nach finalen (F) und korrigierten (c) Daten
        filter(N2LABOR001_N2VSTATUS %in%  c("F", "C")) %>%
  # Median Berechnung  
        group_by(PATID) %>%
        summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
        ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
        left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
        drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
        drop_na(Alter)

#filtern nach männlich
ergm <- erg %>%
        filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
        filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(erg$Alter)

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)

#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)


#Wie viel % innerhalb des Referenzintervalls
mean( ergw$median_labor <= 5)
mean(ergm$median_labor <= 5)
mean(ergwm$median_labor <= 5)

#Referenzbereich
quantile(ergw$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm$median_labor, c(.025, .05, .95, .975)) 

#Speichern als .csv
write.csv2(ergwm, file="crp.csv")



#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))
  
scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "Verteilung der CRP*-Werte [mg/L]",
    subtitle = "aufgeteilt nach Geschlecht",
    caption = "*C-reaktives Protein",
    x = "Geschlecht",
    y = "CRP* [mg/L]"
      )

summary(ergw)
summary(ergm)
summary(ergwm)

# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 100)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 100)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,7),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), main="Altersverteilung", add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 100)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 100)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der CRP-Werte [mg/L]", xlab="CRP [mg/L]", ylab="Anteil [%]", xlim=c(0,500), ylim=c(0,20), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="CRP [mg/L]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))


#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)

# Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergm_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzintervalls
mean( ergw_norm$median_labor <= 5)
mean(ergm_norm$median_labor <= 5)
mean(ergwm_norm$median_labor <= 5)

#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```



#Bilirubin
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaBil2108.xlsx")
names(data)

data1 <- filter(data, N2LABOR001_N2NORMAL=="< 1.20")

erg  <- data1 %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter) %>%
  #Filtern nach Alter 1-99
  filter(Alter>=1 & Alter<=99)
  

#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor < 1.2)
mean(ergm$median_labor < 1.2)
mean(ergwm$median_labor < 1.2)

#Referenzbereich
quantile(ergw$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm$median_labor, c(.025, .05, .95, .975))

#Speichern als .csv
write.csv2(ergwm, file="bilirubin.csv")




#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.3) +
  labs(
    title = "Verteilung der Bilirubin-Werte [mg/dL]",
    subtitle = "aufgeteilt nach Geschlecht",
    x = "Geschlecht",
    y = "Bilirubin [mg/dL]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 100)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 100)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,7),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), main="Altersverteilung", add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 100)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 100)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der Bilirubin-Werte [mg/dL]", xlab="Bilirubin [mg/dL]", ylab="Anteil [%]", xlim=c(0,20), ylim=c(0,60), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="Bilirubin [mg/dL]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))


#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)


#Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergm_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)


#Wie viel % innerhalb des normalverteilten Referenzbereichs
mean(ergw_norm$median_labor < 1.2)
mean(ergm_norm$median_labor < 1.2)
mean(ergwm_norm$median_labor < 1.2)

#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```



#Aspartat-Aminotransferase
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaAst2108.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter) %>%
  #Filtern nach Alter >17
  filter(Alter>17)


#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor < 35)
mean(ergm$median_labor < 50)

#Referenzbereich
quantile(ergw$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm$median_labor, c(.025, .05, .95, .975)) 

#Speichern als .csv
write.csv2(ergwm, file="got(ast).csv")


#Erstellung des Boxplots
scatter <- ergwm %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.3) +
  labs(
    title = "Verteilung der AST*-Werte [U/L]",
    subtitle = "aufgeteilt nach Geschlecht",
    caption = "*Aspartat-Aminotransferase",
    x = "Geschlecht",
    y = "AST* [U/L]"
  )

summary(ergw)
summary(ergm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 100)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 100)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,7),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), main="Altersverteilung", add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 80)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 500)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der AST-Werte [U/L]", xlab="AST [U/L]", ylab="Anteil [%]", xlim=c(0,1000), ylim=c(0,30), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second


#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)

#Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des normalverteilten Referenzbereichs
mean(ergw_norm$median_labor < 35)
mean(ergm_norm$median_labor < 50)

#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
```



#D-Dimer
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaDdi2108.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter)


#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor < 0.5)
mean(ergm$median_labor < 0.5)
mean(ergwm$median_labor < 0.5)

#Referenzbereich
quantile(ergw$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm$median_labor, c(.025, .05, .95, .975))

#Speichern als .csv
write.csv2(ergwm, file="ddimer.csv")


#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.3) +
  labs(
    title = "Verteilung der D-Dimer-Werte [mg/L]",
    subtitle = "aufgeteilt nach Geschlecht",
    x = "Geschlecht",
    y = "D-Dimer [mg/L]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 80)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 80)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,8),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), main="Altersverteilung", add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 100)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 100)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der D-Dimer-Werte [mg/L]", xlab="D-Dimer [mg/L]", ylab="Anteil [%]", xlim=c(0,30), ylim=c(0,15), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="D-Dimer [mg/L]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))


#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)


#Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm, c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des normalverteilten Referenzbereichs
mean(ergw_norm$median_labor < 0.5)
mean(ergm_norm$median_labor < 0.5)
mean(ergwm_norm$median_labor < 0.5)

#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```



#Ferritin
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaFer2108.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter) %>%
  #Filtern nach Alter >19
  filter(Alter>19)


#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor >= 13) - mean( ergw$median_labor <= 150)
mean(ergm$median_labor >= 30) - mean(ergm$median_labor <= 400)

erg95m <- refLimit(ergm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitm <- unname(erg95m$Ref_Int)[1]
upperRefLimitm <- unname(erg95m$Ref_Int)[2]
erg95m

erg95w <- refLimit(ergw$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitw <- unname(erg95w$Ref_Int)[1]
upperRefLimitw <- unname(erg95w$Ref_Int)[2]
erg95w


#Speichern als .csv
write.csv2(ergwm, file="ferritin.csv")

#Erstellung des Boxplots
scatter <- ergwm %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.3) +
  labs(
    title = "Verteilung der Ferritin-Werte [µg/L]",
    subtitle = "aufgeteilt nach Geschlecht",
    x = "Geschlecht",
    y = "Ferritin [µg/L]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 80)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 80)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,7),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), main="Altersverteilung", add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 20)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 100)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der Ferritin-Werte [µg/L]", xlab="Ferritin [µg/L]", ylab="Anteil [%]", xlim=c(0,30000), ylim=c(0,60), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)


#Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergw_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw_norm >= 13)-mean(ergw_norm <= 150)
mean(ergm_norm >= 30)-mean(ergm_norm <= 400)

#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
```



#Gamma-Glutamyltransferase
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaGgt2108.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter)


#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor >= 5)
mean( ergw$median_labor <= 36)
mean(ergm$median_labor >= 8)
mean(ergm$median_labor <= 61)

erg95m <- refLimit(ergm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitm <- unname(erg95m$Ref_Int)[1]
upperRefLimitm <- unname(erg95m$Ref_Int)[2]
erg95m

erg95w <- refLimit(ergw$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitw <- unname(erg95w$Ref_Int)[1]
upperRefLimitw <- unname(erg95w$Ref_Int)[2]
erg95w

#Speichern als .csv
write.csv2(ergwm, file="Ggt.csv")



#Erstellung des Boxplots
scatter <- ergwm %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.3) +
  labs(
    title = "Verteilung der GGT*-Werte [U/L]",
    subtitle = "aufgeteilt nach Geschlecht",
    caption = "*Gamma-Glutamyl-Transferase",
    x = "Geschlecht",
    y = "GGT* [U/L]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 100)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 100)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,7),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), main="Altersverteilung",  add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 100)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 100)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der GGT-Werte [U/L]", xlab="GGT [U/L]", ylab="Anteil [%]", xlim=c(0,2000), ylim=c(0,25), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second


#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)


#Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergw_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw_norm >= 5)
mean(ergw_norm <= 36)
mean(ergm_norm >= 8)
mean(ergm_norm <= 61)

#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
```



#Hämoglobin (für 19 bis 65 Jahre)
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaHbw2108.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter) %>%
  #Filtern nach Alter 19-65
  filter(Alter>=19 & Alter<=65)


#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)


#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor <= 15.6)-(1-mean( ergw$median_labor >= 12))
mean(ergm$median_labor <= 17)-(1-mean(ergm$median_labor >= 13.5)) 

erg95m <- refLimit(ergm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitm <- unname(erg95m$Ref_Int)[1]
upperRefLimitm <- unname(erg95m$Ref_Int)[2]
erg95m

erg95w <- refLimit(ergw$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitw <- unname(erg95w$Ref_Int)[1]
upperRefLimitw <- unname(erg95w$Ref_Int)[2]
erg95w


#Speichern als .csv
write.csv2(ergwm, file="Hämoglobin19-65.csv")


#Erstellung des Boxplots
scatter <- ergwm %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "Verteilung der Hämoglobin-Werte [g/dL]",
    subtitle = "aufgeteilt nach Geschlecht",
    x = "Geschlecht",
    y = "Hämoglobin [g/dL]"
  )



summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 100)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 100)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(10,70), ylim=c(0,10),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 100)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 100)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der Hämoglobin-Werte [g/dL]", xlab="Hämoglobin [g/dL]", ylab="Anteil [%]", xlim=c(5,20), ylim=c(0,7), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="Hämoglobin [g/dL]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))

#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)


#Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergw_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzbereichs
mean(ergw_norm <= 15.6)-(1-mean( ergw_norm >= 12))

mean(ergm_norm <= 17)-(1-mean(ergm_norm >= 13.5)) 


#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 


summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
```




#Hämoglobin (für 19 bis 65 Jahre mit verkleinerter Kohorte)
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaHbw2108.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter) %>%
  #Filtern nach Alter 19-65
  filter(Alter>=19 & Alter<=65)


#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Kohorte verringern (Alter ähnlicher machen)
# random gruppierung: parameters, it_M < it_N (Anzahl männer reduzieren)
it_N <- 236
it_M <- 103# Draw it_m from indexed list of it_N
# set.seed(3) ist gut
set.seed(24)
ar_it_rand_idx <- sample(it_N, it_M, replace=FALSE)
ergm <- ergm[ar_it_rand_idx,]
wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(ergwm)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)


#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05


#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor <= 15.6)-(1-mean( ergw$median_labor >= 12))
mean(ergm$median_labor <= 17)-(1-mean(ergm$median_labor >= 13.5))

erg95m <- refLimit(ergm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitm <- unname(erg95m$Ref_Int)[1]
upperRefLimitm <- unname(erg95m$Ref_Int)[2]
erg95m

erg95w <- refLimit(ergw$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitw <- unname(erg95w$Ref_Int)[1]
upperRefLimitw <- unname(erg95w$Ref_Int)[2]
erg95w

#Speichern als .csv
write.csv2(ergwm, file="Hämoglobin19-65.csv")


#Erstellung des Boxplots
scatter <- ergwm %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "Verteilung der Hämoglobin-Werte [g/dL]",
    subtitle = "aufgeteilt nach Geschlecht",
    x = "Geschlecht",
    y = "Hämoglobin [g/dL]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 100)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 100)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(10,70), ylim=c(0,10),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 100)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 100)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der Hämoglobin-Werte [g/dL]", xlab="Hämoglobin [g/dL]", ylab="Anteil [%]", xlim=c(5,20), ylim=c(0,7), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)


#Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergw_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzbereichs

mean(ergw_norm <= 15.6)-(1-mean( ergw_norm >= 12))
mean(ergm_norm <= 17)-(1-mean(ergm_norm >= 13.5))

#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
```




#Hämoglobin (älter als 65 Jahre)
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaHbw2108.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter) %>%
  #Filtern nach Alter 19-65
  filter(Alter>65)


#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor <= 15.8)-(1-mean( ergw$median_labor >= 11.8))
mean(ergm$median_labor <= 17.2)-(1-mean(ergm$median_labor >= 12.5))

erg95m <- refLimit(ergm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitm <- unname(erg95m$Ref_Int)[1]
upperRefLimitm <- unname(erg95m$Ref_Int)[2]
erg95m

erg95w <- refLimit(ergw$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitw <- unname(erg95w$Ref_Int)[1]
upperRefLimitw <- unname(erg95w$Ref_Int)[2]
erg95w

#Speichern als .csv
write.csv2(ergwm, file="Hämoglobingr65.csv")




#Erstellung des Boxplots
scatter <- ergwm %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "Verteilung der Hämoglobin-Werte [g/dL]",
    subtitle = "aufgeteilt nach Geschlecht",
    x = "Geschlecht",
    y = "Hämoglobin [g/dL]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 50)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 50)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(60,100), ylim=c(0,15),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), main="Altersverteilung",  add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergwm$median_labor, breaks = 100)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 100)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der Hämoglobin-Werte [g/dL]", xlab="Hämoglobin [g/dL]", ylab="Anteil [%]", xlim=c(5,17), ylim=c(0,8), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)


#Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergw_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzbereichs
mean(ergw_norm <= 15.8)-(1-mean(ergw_norm >= 11.8))
mean(ergm_norm <= 17.2)-(1-mean(ergm_norm >= 12.5))

#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)



#Kohorte verringern (Alter ähnlicher machen)
# random gruppierung: parameters, it_M < it_N (Anzahl männer reduzieren)
it_N <- 123
it_M <- 55# Draw it_m from indexed list of it_N
# set.seed(2) ist gut
set.seed(2)
ar_it_rand_idx <- sample(it_N, it_M, replace=FALSE)
ergm <- ergm[ar_it_rand_idx,]
wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(ergwm)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)


#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05


#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor <= 15.6)-(1-mean( ergw$median_labor >= 12))
mean(ergm$median_labor <= 17)-(1-mean(ergm$median_labor >= 13.5))

erg95m <- refLimit(ergm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitm <- unname(erg95m$Ref_Int)[1]
upperRefLimitm <- unname(erg95m$Ref_Int)[2]
erg95m

erg95w <- refLimit(ergw$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitw <- unname(erg95w$Ref_Int)[1]
upperRefLimitw <- unname(erg95w$Ref_Int)[2]
erg95w

#Speichern als .csv
write.csv2(ergwm, file="Hämoglobin19-65.csv")


#Erstellung des Boxplots
scatter <- ergwm %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "Verteilung der Hämoglobin-Werte [g/dL]",
    subtitle = "aufgeteilt nach Geschlecht",
    x = "Geschlecht",
    y = "Hämoglobin [g/dL]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 100)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 100)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(10,70), ylim=c(0,10),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 100)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 100)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der Hämoglobin-Werte [g/dL]", xlab="Hämoglobin [g/dL]", ylab="Anteil [%]", xlim=c(5,20), ylim=c(0,7), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="Hämoglobin [g/dL]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))

#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)


#Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergw_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzbereichs
mean(ergw_norm <= 15.8)-(1-mean( ergw_norm >= 11.8))
mean(ergm_norm <= 17.2)-(1-mean(ergm_norm >= 12.5))

#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
```



#Troponin
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaTrt2108.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter)


#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor < 14)
mean(ergm$median_labor < 14)
mean(ergwm$median_labor < 14)

#Referenzbereich
quantile(ergw$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm$median_labor, c(.025, .05, .95, .975)) 


#Speichern als .csv
write.csv2(ergwm, file="troponin.csv")



#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "Verteilung der Troponin T hs*-Werte [mg/L]",
    subtitle = "aufgeteilt nach Geschlecht",
    caption = "*Troponin T (hochsensitiv)",
    x = "Geschlecht",
    y = "Troponin T hs* [ng/L]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 100)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 100)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,8),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 100)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 100)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der Troponin T hs-Werte [ng/L]", xlab="Troponin T hs [ng/L]", ylab="Anteil [%]", xlim=c(0,850), ylim=c(0,40), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second



#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="Troponin T hs [ng/L]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))


#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)


#Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm, c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des normalverteilten Referenzbereichs
mean(ergw_norm$median_labor < 14)
mean(ergm_norm$median_labor < 14)
mean(ergwm_norm$median_labor < 14)

#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```



#Kreatinin
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaKre2108.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter) %>%
  #Filtern nach Alter >14
  filter(Alter>14)

#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor <= 0.9)-(1-mean( ergw$median_labor >= 0.5))
mean(ergm$median_labor <= 1.2)-(1-mean(ergm$median_labor >= 0.7))

mean(ergw$median_labor < 0.5)
mean(ergm$median_labor < 0.7)
mean(ergw$median_labor > 0.9)
mean(ergm$median_labor > 1.2)

erg95m <- refLimit(ergm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitm <- unname(erg95m$Ref_Int)[1]
upperRefLimitm <- unname(erg95m$Ref_Int)[2]
erg95m

erg95w <- refLimit(ergw$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitw <- unname(erg95w$Ref_Int)[1]
upperRefLimitw <- unname(erg95w$Ref_Int)[2]
erg95w

#Speichern als .csv
write.csv2(ergwm, file="kreatinin.csv")



#Erstellung des Boxplots
scatter <- ergwm %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.3) +
  labs(
    title = "Verteilung der Kreatinin-Werte [mg/dL]",
    subtitle = "aufgeteilt nach Geschlecht",
    x = "Geschlecht",
    y = "Kreatinin [mg/dL]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 100)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 100)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,7),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 50)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 100)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der Kreatinin-Werte [mg/dL]", xlab="Kreatinin [mg/dL]", ylab="Anteil [%]", xlim=c(0,8), ylim=c(0,25), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)


#Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergw_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzbereichs
1- mean(ergw_norm <= 0.9)-mean(ergw_norm >= 0.5)
1-mean(ergm_norm <= 1.2)-mean(ergm_norm >= 0.7)

mean(ergw_norm$median_labor < 0.5)
mean(ergm_norm$median_labor < 0.7)
mean(ergw_norm$median_labor > 0.9)
mean(ergm_norm$median_labor > 1.2)


#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
```



#Laktat-Dehydrogenase
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaLdh2108.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter) %>%
  #Filtern nach Alter >15
  filter(Alter>15)


#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor <= 250)-(1-mean( ergw$median_labor >= 135))
mean(ergm$median_labor <= 250)-(1-mean(ergm$median_labor >= 135))
mean(ergwm$median_labor <= 250)-(1-mean(ergwm$median_labor >= 135))


erg95m <- refLimit(ergm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitm <- unname(erg95m$Ref_Int)[1]
upperRefLimitm <- unname(erg95m$Ref_Int)[2]
erg95m

erg95w <- refLimit(ergw$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitw <- unname(erg95w$Ref_Int)[1]
upperRefLimitw <- unname(erg95w$Ref_Int)[2]
erg95w

erg95wm <- refLimit(ergwm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitwm <- unname(erg95w$Ref_Int)[1]
upperRefLimitwm <- unname(erg95w$Ref_Int)[2]
erg95wm

#Speichern als .csv
write.csv2(ergwm, file="Ldh.csv")



#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "LDH*-Werte [U/L]",
    subtitle = "aufgeteilt nach Geschlecht",
    caption = "*Laktat-Dehydrogenase",
    x = "Geschlecht",
    y = "LDH* [U/L]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 100)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 100)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,7),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 20)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 100)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der LDH-Werte [U/L]", xlab="LDH [U/L]", ylab="Anteil [%]", xlim=c(0,9000), ylim=c(0,50), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second


#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="LDH [U/L]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))

#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)

# Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergm_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzintervalls
mean( ergw_norm$median_labor <= 250)-(1-mean( ergw_norm$median_labor >= 135))
mean(ergm_norm$median_labor <= 250)-(1-mean(ergm_norm$median_labor >= 135))
mean(ergwm_norm$median_labor <= 250)-(1-mean(ergwm_norm$median_labor >= 135))


#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```



#Laktat
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaLak2108.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter)



#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)


#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor <= 20)-(1-mean( ergw$median_labor >= 0))
mean(ergm$median_labor <= 20)-(1-mean(ergm$median_labor >= 0))
mean(ergwm$median_labor <= 20)-(1-mean(ergwm$median_labor >= 0))

mean( ergwm$median_labor >= 20)
mean( ergwm$median_labor <= 0)


erg95m <- refLimit(ergm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitm <- unname(erg95m$Ref_Int)[1]
upperRefLimitm <- unname(erg95m$Ref_Int)[2]
erg95m

erg95w <- refLimit(ergw$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitw <- unname(erg95w$Ref_Int)[1]
upperRefLimitw <- unname(erg95w$Ref_Int)[2]
erg95w

erg95wm <- refLimit(ergwm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                    refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitwm <- unname(erg95w$Ref_Int)[1]
upperRefLimitwm <- unname(erg95w$Ref_Int)[2]
erg95wm

#Referenzbereich
quantile(ergw$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm$median_labor, c(.025, .05, .95, .975))

#Speichern als .csv
write.csv2(ergwm, file="laktose.csv")



#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "Laktat-Werte [mg/dL]",
    subtitle = "aufgeteilt nach Geschlecht",
    x = "Geschlecht",
    y = "Laktose [mg/dL]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 100)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 100)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,7),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 10)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 50)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der Laktat-Werte [mg/dL]", xlab="Laktat [mg/dL]", ylab="Anteil [%]", xlim=c(0,150), ylim=c(0,25), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="Laktat [mg/dL]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))

#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)

# Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergm_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzintervalls
mean(ergw_norm$median_labor <= 20)-(1-mean(ergw_norm$median_labor >= 0))
mean(ergm_norm$median_labor <= 20)-(1-mean(ergm_norm$median_labor >= 0))
mean(ergwm_norm$median_labor <= 20)-(1-mean(ergwm_norm$median_labor >= 0))


#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```



#Albumin
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaAlb2108.xlsx")
names(data)

data1 <- filter(data, N2LABOR001_N2UNIT=="g/l")

erg  <- data1 %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter)

#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

erg95m <- refLimit(ergm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitm <- unname(erg95m$Ref_Int)[1]
upperRefLimitm <- unname(erg95m$Ref_Int)[2]
erg95m

erg95w <- refLimit(ergw$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitw <- unname(erg95w$Ref_Int)[1]
upperRefLimitw <- unname(erg95w$Ref_Int)[2]
erg95w

erg95wm <- refLimit(ergwm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                    refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitwm <- unname(erg95w$Ref_Int)[1]
upperRefLimitwm <- unname(erg95w$Ref_Int)[2]
erg95wm

#Speichern als .csv
write.csv2(ergwm, file="albumin.csv")

#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "Albumin-Werte [g/L]",
    subtitle = "aufgeteilt nach Geschlecht",
    x = "Geschlecht",
    y = "Albumin [g/L]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 100)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 100)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,7),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 80)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 80)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der Albumin-Werte [g/L]", xlab="Albumin [g/L]", ylab="Anteil [%]", xlim=c(10,50), ylim=c(0,10), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second


#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="Albumin [g/L]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))

#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)

# Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergm_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)


#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```



#Fibrinogen
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaFib2108.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter)



#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean(ergw$median_labor <= 4.2)-(1-mean(ergw$median_labor >= 1.6))
mean(ergm$median_labor <= 4.2)-(1-mean(ergm$median_labor >= 1.6))
mean(ergwm$median_labor <= 4.2)-(1-mean(ergwm$median_labor >= 1.6))

erg95m <- refLimit(ergm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitm <- unname(erg95m$Ref_Int)[1]
upperRefLimitm <- unname(erg95m$Ref_Int)[2]
erg95m

erg95w <- refLimit(ergw$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitw <- unname(erg95w$Ref_Int)[1]
upperRefLimitw <- unname(erg95w$Ref_Int)[2]
erg95w

erg95wm <- refLimit(ergwm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                    refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitwm <- unname(erg95w$Ref_Int)[1]
upperRefLimitwm <- unname(erg95w$Ref_Int)[2]
erg95wm

#Speichern als .csv
write.csv2(ergwm, file="Fibrinogen.csv")



#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "Fibrinogen-Werte [g/L]",
    subtitle = "aufgeteilt nach Geschlecht",
    x = "Geschlecht",
    y = "Fibrinogen [g/L]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 80)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 80)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,10),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 50)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 70)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der Fibrinogen-Werte [g/L]", xlab="Fibrinogen [g/L]", ylab="Anteil [%]", xlim=c(0,13), ylim=c(0,12), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second


#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="Fibrinogen [g/L]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))

#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)

# Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergm_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzintervalls
mean(ergw_norm$median_labor <= 4.2)-(1-mean(ergw_norm$median_labor >= 1.6))
mean(ergm_norm$median_labor <= 4.2)-(1-mean(ergm_norm$median_labor >= 1.6))
mean(ergwm_norm$median_labor <= 4.2)-(1-mean(ergwm_norm$median_labor >= 1.6))

#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```



#Antithrombin
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")


# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaAth2108.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter)



#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor <= 120)-(1-mean(ergw$median_labor >= 79))
mean(ergm$median_labor <= 120)-(1-mean(ergm$median_labor >= 79))
mean(ergwm$median_labor <= 120)-(1-mean(ergwm$median_labor >= 79))

erg95m <- refLimit(ergm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitm <- unname(erg95m$Ref_Int)[1]
upperRefLimitm <- unname(erg95m$Ref_Int)[2]
erg95m

erg95w <- refLimit(ergw$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitw <- unname(erg95w$Ref_Int)[1]
upperRefLimitw <- unname(erg95w$Ref_Int)[2]
erg95w

erg95wm <- refLimit(ergwm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                    refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitwm <- unname(erg95w$Ref_Int)[1]
upperRefLimitwm <- unname(erg95w$Ref_Int)[2]
erg95wm

#Speichern als .csv
write.csv2(ergwm, file="antithrombin.csv")



#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "Antithrombin-Werte [%]",
    subtitle = "aufgeteilt nach Geschlecht",
    x = "Geschlecht",
    y = "Antithrombin [%]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 80)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 80)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,10),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 50)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 50)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der Antithrombin-Werte [%]", xlab="Antirhrombin [%]", ylab="Anteil [%]", xlim=c(20,140), ylim=c(0,10), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="Antirhrombin [%]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))

#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)

# Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergm_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzintervalls
mean( ergw_norm$median_labor <= 120)-(1-mean(ergw_norm$median_labor >= 79))
mean(ergm_norm$median_labor <= 120)-(1-mean(ergm_norm$median_labor >= 79))
mean(ergwm_norm$median_labor <= 120)-(1-mean(ergwm_norm$median_labor >= 79))



#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```



#Interleukin-6
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaIl62108.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter) %>%
  #Filtern nach Alter >18
  filter(Alter>18)


#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor < 7)
mean(ergm$median_labor < 7)
mean(ergwm$median_labor < 7)


#Referenzbereich
quantile(ergw$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm$median_labor, c(.025, .05, .95, .975)) 

#Speichern als .csv
write.csv2(ergwm, file="IL6.csv")


#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "Interleukin-Werte [ng/L]",
    subtitle = "aufgeteilt nach Geschlecht",
    x = "Geschlecht",
    y = "Interleukin [ng/L]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 80)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 80)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,8),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 5)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 80)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der Interleukin-6-Werte [ng/L]", xlab="Interleukin-6 [ng/L]", ylab="Anteil [%]", xlim=c(0,7000), ylim=c(0,90), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second


#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="Interleukin-6 [ng/L]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))


#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="CRP [mg/L]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))


#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)

# Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergm_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzintervalls
mean( ergw_norm$median_labor < 7)
mean(ergm_norm$median_labor < 7)
mean(ergwm_norm$median_labor < 7)

#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```



#Leukozyten
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaLeu2108.xlsx")
names(data)

data1 <- filter(data, N2LABOR001_N2NORMAL=="3.90-10.50")

erg  <- data1 %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter) %>%
  #Filtern nach Alter >18
  filter(Alter>18)

#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor <= 10.5)-(1-mean( ergw$median_labor >= 3.9))
mean(ergm$median_labor <= 10.5)-(1-mean(ergm$median_labor >= 3.9))
mean(ergwm$median_labor <= 10.5)-(1-mean(ergwm$median_labor >= 3.9))

mean(ergwm$median_labor > 10.5)
mean(ergwm$median_labor < 3.9)

erg95m <- refLimit(ergm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitm <- unname(erg95m$Ref_Int)[1]
upperRefLimitm <- unname(erg95m$Ref_Int)[2]
erg95m

erg95w <- refLimit(ergw$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitw <- unname(erg95w$Ref_Int)[1]
upperRefLimitw <- unname(erg95w$Ref_Int)[2]
erg95w

erg95wm <- refLimit(ergwm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                    refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitwm <- unname(erg95w$Ref_Int)[1]
upperRefLimitwm <- unname(erg95w$Ref_Int)[2]
erg95wm

#Speichern als .csv
write.csv2(ergwm, file="Leukozyten_nL.csv")



#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "Leukozyten-Werte [/nL]",
    subtitle = "aufgeteilt nach Geschlecht",
    x = "Geschlecht",
    y = "Leukozyten [/nL]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 80)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 80)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,8),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 50)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 80)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der Leukozyten-Werte [/nL]", xlab="Leukozyten [/nL]", ylab="Anteil [%]", xlim=c(0,70), ylim=c(0,20), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="Leukozyten [/nL]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))

#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)

# Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergm_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzintervalls
mean( ergw_norm$median_labor <= 10.5)-(1-mean( ergw_norm$median_labor >= 3.9))
mean(ergm_norm$median_labor <= 10.5)-(1-mean(ergm_norm$median_labor >= 3.9))
mean(ergwm_norm$median_labor <= 10.5)-(1-mean(ergwm_norm$median_labor >= 3.9))
mean(ergwm_norm$median_labor >= 10.5)
mean(ergwm_norm$median_labor <= 3.9)

#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```



#Lymphozyten [/nL]
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaLym2108.xlsx")
names(data)

data1 <- filter(data, N2LABOR001_N2NORMAL=="1.10-4.50")

erg  <- data1 %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter) %>%
  #Filtern nach Alter >18
  filter(Alter>18)


#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor <= 4.5)-(1-mean(ergw$median_labor >= 1.1))
mean(ergm$median_labor <= 4.5)-(1-mean(ergm$median_labor >= 1.1))
mean(ergwm$median_labor <= 4.5)-(1-mean(ergwm$median_labor >= 1.1))

erg95m <- refLimit(ergm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitm <- unname(erg95m$Ref_Int)[1]
upperRefLimitm <- unname(erg95m$Ref_Int)[2]
erg95m

erg95w <- refLimit(ergw$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitw <- unname(erg95w$Ref_Int)[1]
upperRefLimitw <- unname(erg95w$Ref_Int)[2]
erg95w

erg95wm <- refLimit(ergwm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                    refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitwm <- unname(erg95w$Ref_Int)[1]
upperRefLimitwm <- unname(erg95w$Ref_Int)[2]
erg95wm

#Speichern als .csv
write.csv2(ergwm, file="Lymphozyten_nL.csv")


#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "Lymphozyten-Werte [/nL]",
    subtitle = "aufgeteilt nach Geschlecht",
    x = "Geschlecht",
    y = "Lymphozyten [/nL]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 80)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 80)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,6),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 80)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 80)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der Lymphozyten-Werte [/nL]", xlab="Lymphozyten [/nL]", ylab="Anteil [%]", xlim=c(0,5), ylim=c(0,5), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="Lymphozyten [/nL]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))

#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)

# Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergm_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzintervalls
mean(ergw_norm$median_labor <= 4.5)-(1-mean(ergw_norm$median_labor >= 1.1))
mean(ergm_norm$median_labor <= 4.5)-(1-mean(ergm_norm$median_labor >= 1.1))
mean(ergwm_norm$median_labor <= 4.5)-(1-mean(ergwm_norm$median_labor >= 1.1))


#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```



#Lymphozyten [%]
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaLym2108.xlsx")
names(data)

data1 <- filter(data, N2LABOR001_N2NORMAL=="20.0-44.0")

erg  <- data1 %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter) %>%
  #Filtern nach Alter >18
  filter(Alter>18)


#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor <= 44)-(1-mean( ergw$median_labor >= 20))
mean(ergm$median_labor <= 44)-(1-mean(ergm$median_labor >= 20))
mean(ergwm$median_labor <= 44)-(1-mean(ergwm$median_labor >= 20))

erg95m <- refLimit(ergm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitm <- unname(erg95m$Ref_Int)[1]
upperRefLimitm <- unname(erg95m$Ref_Int)[2]
erg95m

erg95w <- refLimit(ergw$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitw <- unname(erg95w$Ref_Int)[1]
upperRefLimitw <- unname(erg95w$Ref_Int)[2]
erg95w

erg95wm <- refLimit(ergwm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                    refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitwm <- unname(erg95w$Ref_Int)[1]
upperRefLimitwm <- unname(erg95w$Ref_Int)[2]
erg95wm

#Speichern als .csv
write.csv2(ergwm, file="Lymphozyten_%.csv")



#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "Lymphozyten-Werte [%]",
    subtitle = "aufgeteilt nach Geschlecht",
    x = "Geschlecht",
    y = "Lymphozyten [%]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 80)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 80)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,7),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 50)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 80)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der Lymphozyten-Werte [%]", xlab="Lymphozyten [%]", ylab="Anteil [%]", xlim=c(0,80), ylim=c(0,7), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second


#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="Lymphozyten [%]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))

#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)

# Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergm_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzintervalls
mean( ergw_norm$median_labor <= 44)-(1-mean( ergw_norm$median_labor >= 20))
mean(ergm_norm$median_labor <= 44)-(1-mean(ergm_norm$median_labor >= 20))
mean(ergwm_norm$median_labor <= 44)-(1-mean(ergwm_norm$median_labor >= 20))


#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```



#Neutrophile [/nL]
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaNeu2108.xlsx")
names(data)

data1 <- filter(data, N2LABOR001_N2NORMAL=="1.50-7.70")

erg  <- data1 %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter) %>%
  #Filtern nach Alter >18
  filter(Alter>18)


#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean(ergw$median_labor <= 7.7)-(1-mean(ergw$median_labor >= 1.5))
mean(ergm$median_labor <= 7.7)-(1-mean(ergm$median_labor >= 1.5))
mean(ergwm$median_labor <= 7.7)-(1-mean(ergwm$median_labor >= 1.5))


erg95m <- refLimit(ergm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitm <- unname(erg95m$Ref_Int)[1]
upperRefLimitm <- unname(erg95m$Ref_Int)[2]
erg95m

erg95w <- refLimit(ergw$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitw <- unname(erg95w$Ref_Int)[1]
upperRefLimitw <- unname(erg95w$Ref_Int)[2]
erg95w

erg95wm <- refLimit(ergwm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                    refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitwm <- unname(erg95w$Ref_Int)[1]
upperRefLimitwm <- unname(erg95w$Ref_Int)[2]
erg95wm

#Speichern als .csv
write.csv2(ergwm, file="Neutrophile_nL.csv")


#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "Neutrophile-Werte [/nL]",
    subtitle = "aufgeteilt nach Geschlecht",
    x = "Geschlecht",
    y = "Neutrophile [/nL]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 80)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 80)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,7),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 80)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 80)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der Neutrophile-Werte [/nL]", xlab="Neutrophile [/nL]", ylab="Anteil [%]", xlim=c(0,25), ylim=c(0,6), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="Neutrophile [/nL]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))

#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)

# Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergm_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzintervalls
mean(ergw_norm$median_labor <= 7.7)-(1-mean(ergw_norm$median_labor >= 1.5))
mean(ergm_norm$median_labor <= 7.7)-(1-mean(ergm_norm$median_labor >= 1.5))
mean(ergwm_norm$median_labor <= 7.7)-(1-mean(ergwm_norm$median_labor >= 1.5))


#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```



#Neutrophile [%]
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaNeu2108.xlsx")
names(data)

data1 <- filter(data, N2LABOR001_N2NORMAL=="42.0-77.0")

erg  <- data1 %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter) %>%
  #Filtern nach Alter >18
  filter(Alter>18)


#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor <= 77)-(1-mean( ergw$median_labor >= 42))
mean(ergm$median_labor <= 77)-(1-mean(ergm$median_labor >= 42))
mean(ergwm$median_labor <= 77)-(1-mean(ergwm$median_labor >= 42))

erg95m <- refLimit(ergm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitm <- unname(erg95m$Ref_Int)[1]
upperRefLimitm <- unname(erg95m$Ref_Int)[2]
erg95m

erg95w <- refLimit(ergw$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitw <- unname(erg95w$Ref_Int)[1]
upperRefLimitw <- unname(erg95w$Ref_Int)[2]
erg95w

erg95wm <- refLimit(ergwm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                    refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitwm <- unname(erg95w$Ref_Int)[1]
upperRefLimitwm <- unname(erg95w$Ref_Int)[2]
erg95wm

#Speichern als .csv
write.csv2(ergwm, file="Neutrophile_%.csv")


#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "Neutrophile-Werte [%]",
    subtitle = "aufgeteilt nach Geschlecht",
    x = "Geschlecht",
    y = "Neutrophile [%]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 80)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 80)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,7),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 50)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 80)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der Neutrophile-Werte [%]", xlab="Neutrophile [%]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,7), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="Neutrophile [%]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))

#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)

# Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergm_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzintervalls
mean(ergw_norm$median_labor >= 42)
mean(ergw_norm$median_labor <= 77)
mean(ergm_norm$median_labor >= 42)
mean(ergm_norm$median_labor <= 77)
mean(ergwm_norm$median_labor >= 42)
mean(ergwm_norm$median_labor <= 77)


#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```



#Procalcitonin
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaPct2108.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter) %>%
  #Filtern nach Alter >18
  filter(Alter>18)


#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired = FALSE)

#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor < 0.5)
mean(ergm$median_labor < 0.5)
mean(ergwm$median_labor < 0.5)

#Referenzbereich
quantile(ergw$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm$median_labor, c(.025, .05, .95, .975)) 


#Speichern als .csv
write.csv2(ergwm, file="procalcitonin.csv")


#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "Procalcitonin-Werte [µg/l]",
    subtitle = "aufgeteilt nach Geschlecht",
    x = "Geschlecht",
    y = "Procalcitonin [µg/L]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 80)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 80)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,7),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 50)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 30)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der Procalcitonin-Werte [µg/L]", xlab="Procalcitonin [µg/L]", ylab="Anteil [%]", xlim=c(0,12), ylim=c(0,70), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="Procalcitonin [µg/L]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))

#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)


#Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm, c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des normalverteilten Referenzbereichs
mean(ergw_norm$median_labor < 0.5)
mean(ergm_norm$median_labor < 0.5)
mean(ergwm_norm$median_labor < 0.5)

#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```



#Thrombozyten
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaThr2108.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter) %>%
  #Filtern nach Alter >18
  filter(Alter>18)


#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean(ergw$median_labor <= 370)-(1-mean(ergw$median_labor >= 150))
mean(ergm$median_labor <= 370)-(1-mean(ergm$median_labor >= 150))
mean(ergwm$median_labor <= 370)-(1-mean(ergwm$median_labor >= 150))
mean(ergwm$median_labor > 370)
mean(ergwm$median_labor < 150)

erg95m <- refLimit(ergm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitm <- unname(erg95m$Ref_Int)[1]
upperRefLimitm <- unname(erg95m$Ref_Int)[2]
erg95m

erg95w <- refLimit(ergw$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitw <- unname(erg95w$Ref_Int)[1]
upperRefLimitw <- unname(erg95w$Ref_Int)[2]
erg95w

erg95wm <- refLimit(ergwm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                    refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitwm <- unname(erg95w$Ref_Int)[1]
upperRefLimitwm <- unname(erg95w$Ref_Int)[2]
erg95wm

#Speichern als .csv
write.csv2(ergwm, file="Thrombozyten_nL.csv")


#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "Thrombozyten-Werte [/nL]",
    subtitle = "aufgeteilt nach Geschlecht",
    x = "Geschlecht",
    y = "Thrombozyten [/nL]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 80)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 80)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,7),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 80)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 80)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der Thrombozyten-Werte [/nL]", xlab="Thrombozyten [/nL]", ylab="Anteil [%]", xlim=c(0,650), ylim=c(0,7), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="Thrombozyten [/nL]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))


#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)

# Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergm_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzintervalls
mean(ergw_norm$median_labor <= 370)-(1-mean(ergw_norm$median_labor >= 150))
mean(ergm_norm$median_labor <= 370)-(1-mean(ergm_norm$median_labor >= 150))
mean(ergwm_norm$median_labor <= 370)-(1-mean(ergwm_norm$median_labor >= 150))
mean(ergwm_norm$median_labor > 370)
mean(ergwm_norm$median_labor < 150)


#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 


summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```



#Quickwert der Thromboplastinzeit
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaTpz2108.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter)



#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor >= 70)
mean( ergw$median_labor <= 130)
mean(ergm$median_labor >= 70)
mean(ergm$median_labor <= 130)
mean(ergwm$median_labor >= 70)
mean(ergwm$median_labor <= 130)

erg95m <- refLimit(ergm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitm <- unname(erg95m$Ref_Int)[1]
upperRefLimitm <- unname(erg95m$Ref_Int)[2]
erg95m

erg95w <- refLimit(ergw$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitw <- unname(erg95w$Ref_Int)[1]
upperRefLimitw <- unname(erg95w$Ref_Int)[2]
erg95w

erg95wm <- refLimit(ergwm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                    refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitwm <- unname(erg95w$Ref_Int)[1]
upperRefLimitwm <- unname(erg95w$Ref_Int)[2]
erg95wm

#Speichern als .csv
write.csv2(ergwm, file="quickTPZ.csv")


#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "qTPZ*-Werte [%]",
    subtitle = "aufgeteilt nach Geschlecht",
    caption = "*Quickwert für die Thromboplastinzeit",
    x = "Geschlecht",
    y = "qTPZ [%]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 80)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 80)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,7),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 80)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 80)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der qTPZ-Werte [%]", xlab="qTPZ [%]", ylab="Anteil [%]", xlim=c(0,120), ylim=c(0,7), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="qTPZ [%]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))

#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)

# Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergm_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzintervalls
mean(ergw_norm$median_labor >= 70)
mean(ergw_norm$median_labor <= 130)
mean(ergm_norm$median_labor >= 70)
mean(ergm_norm$median_labor <= 130)
mean(ergwm_norm$median_labor >= 70)
mean(ergwm_norm$median_labor <= 130)


#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```



#International Normalized Ratio
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaInr2111.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter)



#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor >= 0.9)
mean( ergw$median_labor <= 1.25)
mean(ergm$median_labor >= 0.9)
mean(ergm$median_labor <= 1.25)
mean(ergwm$median_labor >= 0.9)
mean(ergwm$median_labor <= 1.25)

erg95m <- refLimit(ergm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitm <- unname(erg95m$Ref_Int)[1]
upperRefLimitm <- unname(erg95m$Ref_Int)[2]
erg95m

erg95w <- refLimit(ergw$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                   refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitw <- unname(erg95w$Ref_Int)[1]
upperRefLimitw <- unname(erg95w$Ref_Int)[2]
erg95w

erg95wm <- refLimit(ergwm$median_labor, out.method = "horn", out.rm = FALSE, RI = "n", CI = "p",
                    refConf = 0.95, limitConf = 0.9, bootStat = "basic")
lowerRefLimitwm <- unname(erg95w$Ref_Int)[1]
upperRefLimitwm <- unname(erg95w$Ref_Int)[2]
erg95wm

#Speichern als .csv
write.csv2(ergwm, file="INR.csv")


#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "INR*-Werte [-]",
    subtitle = "aufgeteilt nach Geschlecht",
    caption = "*International Normalized Ratio",
    x = "Geschlecht",
    y = "INR [-]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 80)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 80)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(0,100), ylim=c(0,7),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 50)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 80)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der INR-Werte [-]", xlab="INR [-]", ylab="Anteil [%]", xlim=c(0.5,3.5), ylim=c(0,25), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second


#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="INR [-]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))

#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)

# Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergm_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzintervalls
mean(ergw_norm$median_labor >= 0.9)
mean(ergw_norm$median_labor <= 1.25)
mean(ergm_norm$median_labor >= 0.9)
mean(ergm_norm$median_labor <= 1.25)
mean(ergwm_norm$median_labor >= 0.9)
mean(ergwm_norm$median_labor <= 1.25)


#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```



#N-terminales Prohormon des natriuretischen Peptids (bis 44 Jahre)
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaBnp2111.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter) %>%
  #Filtern nach Alter bis 44
  filter(Alter<=44)

#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor <= 97)
mean(ergm$median_labor <= 97)
mean(ergwm$median_labor <= 97)

#Referenzbereich
quantile(ergw$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm$median_labor, c(.025, .05, .95, .975)) 

#Speichern als .csv
write.csv2(ergwm, file="ntprobnp44.csv")


#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "NT-Pro BNP*-Werte [ng/L]",
    subtitle = "aufgeteilt nach Geschlecht",
    caption = "*N-terminales Prohormon des natriuretischen Peptids",
    x = "Geschlecht",
    y = "NT-Pro BNP* [ng/L]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 80)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 80)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(15,45), ylim=c(0,20),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 80)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 80)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der NT-Pro BNP-Werte [ng/L]", xlab="NT-Pro BNP [ng/L]", ylab="Anteil [%]", xlim=c(0,12000), ylim=c(0,90), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="NT-Pro BNP [ng/L]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))

#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)

# Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergm_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzintervalls
mean(ergw_norm$median_labor < 97)
mean(ergm_norm$median_labor < 97)
mean(ergwm_norm$median_labor < 97)


#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```



#N-terminales Prohormon des natriuretischen Peptids (45 Jahre bis 54 Jahre)
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaBnp2111.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter) %>%
  #Filtern nach Alter 65-74
  filter(Alter>=45 & Alter<=54)

#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor < 121)
mean(ergm$median_labor < 121)
mean(ergwm$median_labor < 121)

#Referenzbereich
quantile(ergw$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm$median_labor, c(.025, .05, .95, .975)) 

#Speichern als .csv
write.csv2(ergwm, file="ntprobnp45.csv")

#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "NT-Pro BNP*-Werte [ng/L]",
    subtitle = "aufgeteilt nach Geschlecht",
    caption = "*N-terminales Prohormon des natriuretischen Peptids",
    x = "Geschlecht",
    y = "NT-Pro BNP* [ng/L]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 80)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 80)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(45,55), ylim=c(0,25),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 50)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 1000)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der NT-Pro BNP-Werte [ng/L]", xlab="NT-Pro BNP [ng/L]", ylab="Anteil [%]", xlim=c(0,5000), ylim=c(0,40), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="NT-Pro BNP [ng/L]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))


#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)

# Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergm_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzintervalls
mean(ergw_norm$median_labor < 121)
mean(ergm_norm$median_labor < 121)
mean(ergwm_norm$median_labor < 121)


#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```



#N-terminales Prohormon des natriuretischen Peptids (55 Jahre bis 64 Jahre)
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaBnp2111.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter) %>%
  #Filtern nach Alter 1-99
  filter(Alter>=55 & Alter<=64)


#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor <= 198)
mean(ergm$median_labor <= 198)
mean(ergwm$median_labor <= 198)

#Referenzbereich
quantile(ergw$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm$median_labor, c(.025, .05, .95, .975)) 


#Speichern als .csv
write.csv2(ergwm, file="ntprobnp.csv")



#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "NT-Pro BNP*-Werte [ng/L]",
    subtitle = "aufgeteilt nach Geschlecht",
    caption = "*N-terminales Prohormon des natriuretischen Peptids",
    x = "Geschlecht",
    y = "NT-Pro BNP* [ng/L]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 80)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 80)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(55,65), ylim=c(0,25),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 100)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 100)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der NT-Pro BNP-Werte [ng/L]", xlab="NT-Pro BNP [ng/L]", ylab="Anteil [%]", xlim=c(0,35000), ylim=c(0,70), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="NT-Pro BNP [ng/L]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))

#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)

# Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergm_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzintervalls
mean(ergw_norm$median_labor < 198)
mean(ergm_norm$median_labor < 198)
mean(ergwm_norm$median_labor < 198)


#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```



#N-terminales Prohormon des natriuretischen Peptids (65 Jahre bis 74 Jahre)
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaBnp2111.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter) %>%
  #Filtern nach Alter 65-74
  filter(Alter>=65 & Alter<=74)

#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor < 285)
mean(ergm$median_labor < 285)
mean(ergwm$median_labor < 285)

#Referenzbereich
quantile(ergw$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm$median_labor, c(.025, .05, .95, .975)) 

#Speichern als .csv
write.csv2(ergwm, file="ntprobnp65.csv")



#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "NT-Pro BNP*-Werte [ng/L]",
    subtitle = "aufgeteilt nach Geschlecht",
    caption = "*N-terminales Prohormon des natriuretischen Peptids",
    x = "Geschlecht",
    y = "NT-Pro BNP* [ng/L]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 80)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 80)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(65,75), ylim=c(0,25),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 50)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 100)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der NT-Pro BNP-Werte [ng/L]", xlab="NT-Pro BNP [ng/L]", ylab="Anteil [%]", xlim=c(0,20000), ylim=c(0,35), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="NT-Pro BNP [ng/L]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))

#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)

# Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergm_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzintervalls
mean(ergw_norm$median_labor < 285)
mean(ergm_norm$median_labor < 285)
mean(ergwm_norm$median_labor < 285)


#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```




#N-terminales Prohormon des natriuretischen Peptids (ab 75 Jahre)
```{r}
# set workspace
setwd("C:\\Users\\user\\Desktop\\R Dateien")

# read data
library(readxl)
library(magrittr)
library(dplyr)
library(ggplot2)
library(Gmisc)
library(tidyr)
library(pwr)
library(referenceIntervals)

Geschlecht_und_Alter <- read_excel("Geschlecht und Alter.xlsx")

# rename
names(Geschlecht_und_Alter) <- c("PATID","Alter","Geschlecht")
data <- read_excel("ExpNinaBnp2111.xlsx")
names(data)

erg  <- data %>% 
  # Filtern nach finalen (F) und korrigierten (c) Daten
  filter(N2LABOR001_N2VSTATUS %in%  c("F", "C"), ) %>%
  # Median Berechnung  
  group_by(PATID) %>%
  summarise(median_labor = median(N2LABOR001_N2VALUE,na.rm = T)) %>%
  ungroup() %>%
  #.Mergen der Labordaten mit den Geschlechterangaben und den Altersangaben
  left_join(Geschlecht_und_Alter) %>%
  # Drop NA in Laborwerte 
  drop_na(median_labor,Geschlecht) %>%
  # Drop NA in Alter
  drop_na(Alter) %>%
  #Filtern nach Alter >74
  filter(Alter>=75)

#filtern nach männlich
ergm <- erg %>%
  filter(Geschlecht=="Männlich")

#filtern nach weiblich
ergw <- erg %>%
  filter(Geschlecht=="Weiblich")

#Alter
#Test, ob Normalverteilung des Alters vorliegt
shapiro.test(ergm$Alter) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$Alter) # keine Normalverteilung, da p < 0.05

#Statistischer Vergleich mit Wilcoxon-Test: Alter
attach(erg)
mergeDesc(getDescriptionStatsBy(Alter, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(erg)

wilcox.test(ergw$Alter,ergm$Alter, paired=FALSE)




#Labordaten
#Test, ob Normalverteilung der Labordaten vorliegt
shapiro.test(ergm$median_labor) # keine Normalverteilung, da p < 0.05
shapiro.test(ergw$median_labor) # keine Normalverteilung, da p < 0.05

#merge the two dataframes
ergwm <- rbind(ergw, ergm)

#Statistischer Vergleich mit Wilcoxon-Test: Laborwerte (muss >0.05)
attach(ergwm)
mergeDesc(getDescriptionStatsBy(median_labor, Geschlecht,
                                statistics = T,
                                header_count = T) ,
          htmlTable_args = list(caption = "wilcox nonparameter test"))
detach(ergwm)

wilcox.test(ergw$median_labor,ergm$median_labor, paired = FALSE)

#Wie viel % innerhalb des Referenzbereichs
mean( ergw$median_labor < 526)
mean(ergm$median_labor < 526)
mean(ergwm$median_labor < 526)

#Referenzbereich
quantile(ergw$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm$median_labor, c(.025, .05, .95, .975)) 

#Speichern als .csv
write.csv2(ergwm, file="ntprobnp75.csv")


#Erstellung des Boxplots
Df2 <- data.frame(Geschlecht=c("Gesamt"),
                  median_labor=ergwm$median_labor)
Df1 <- bind_rows(ergwm, Df2)

scatter <- Df1 %>% 
  ggplot(mapping = aes(x = Geschlecht, 
                       y = median_labor,
                       colour = Geschlecht))

scatter + 
  geom_violin(fill="#D3D3D3", alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.6) + 
  coord_flip() + 
  geom_boxplot(width=0.2) +
  labs(
    title = "NT-Pro BNP*-Werte [ng/L]",
    subtitle = "aufgeteilt nach Geschlecht",
    caption = "*N-terminales Prohormon des natriuretischen Peptids",
    x = "Geschlecht",
    y = "NT-Pro BNP* [ng/L]"
  )

summary(ergw)
summary(ergm)
summary(ergwm)



# übereinandergelegte histogramme zum Alter
h1w <- hist(ergw$Alter, breaks = 80)
h1w$density = h1w$counts / sum(h1w$counts) * 100
h2m <- hist(ergm$Alter, breaks = 80)
h2m$density = h2m$counts / sum(h2m$counts) * 100
plot(h1w, col=rgb(0,0,1,1/4), main="Altersverteilung", xlab="Alter [J]", ylab="Anteil [%]", xlim=c(75,95), ylim=c(0,30),freq=FALSE)  # first histogram
plot(h2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

# übereinandergelegte histogramme zum Laborwert
l1w <- hist(ergw$median_labor, breaks = 50)
l1w$density = l1w$counts / sum(l1w$counts) * 100
l2m <- hist(ergm$median_labor, breaks = 100)
l2m$density = l2m$counts / sum(l2m$counts) * 100
plot(l1w, col=rgb(0,0,1,1/4), main="Verteilung der NT-Pro BNP-Werte [ng/L]", xlab="NT-Pro BNP [ng/L]", ylab="Anteil [%]", xlim=c(0,35000), ylim=c(0,30), freq=FALSE)  # first histogram
plot(l2m, col=rgb(1,0,0,1/4), add=T, freq=FALSE)  # second

#gesplittete violin plots zum Laborwert
library(vioplot)
vioplot(ergw$median_labor,
        colMed = "grey", # Color of the median point
        side = "right",   # Right side
        col = "#BFBFFF",
        ylab="NT-Pro BNP [ng/L]")  # Color for the right side
vioplot(ergm$median_labor,
        colMed = "grey", # Color of the median point
        side = "left",    # Left side
        col = "#FFBFBF",  # Color for the left side
        add = TRUE)       # Add it to the previous plot

legend("topleft",
       legend = c("Weiblich", "Männlich"),
       fill = c("#BFBFFF", "#FFBFBF"))


#Aufarbeitung der Daten vornehmen
library(moments)
skewness(ergm$median_labor, na.rm = TRUE)
skewness(ergw$median_labor, na.rm = TRUE)
skewness(ergwm$median_labor, na.rm = TRUE)

# Outliers
outliers <- function(x) {
  
  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1
  
  upper_limit = Q3 + (iqr*1.5)
  lower_limit = Q1 - (iqr*1.5)
  
  x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

ergw_norm <- remove_outliers(ergw, c("median_labor"))
ergm_norm <- remove_outliers(ergm,c("median_labor"))
ergwm_norm <- remove_outliers(ergwm,c("median_labor"))

skewness(ergw_norm$median_labor, na.rm = TRUE)
skewness(ergm_norm$median_labor, na.rm = TRUE)
skewness(ergwm_norm$median_labor, na.rm = TRUE)

#Wie viel % innerhalb des Referenzintervalls
mean(ergw_norm$median_labor < 526)
mean(ergm_norm$median_labor < 526)
mean(ergwm_norm$median_labor < 526)


#Referenzbereich
quantile(ergw_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergm_norm$median_labor, c(.025, .05, .95, .975)) 
quantile(ergwm_norm$median_labor, c(.025, .05, .95, .975)) 

summary(ergw)
summary(ergw_norm)
summary(ergm)
summary(ergm_norm)
summary(ergwm)
summary(ergwm_norm)
```

